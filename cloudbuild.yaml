steps:
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        SECRET_VAL=$(gcloud secrets versions access latest --secret="STARWARS_API_KEY")
        
        gcloud functions deploy starwars-backend \
          --gen2 \
          --runtime=python311 \
          --region=us-central1 \
          --source=. \
          --entry-point=starwars_api \
          --trigger-http \
          --no-allow-unauthenticated \
          --ingress-settings=internal-and-gclb \
          --set-env-vars=API_KEY=$$SECRET_VAL

        BACKEND_URL=$(gcloud functions describe starwars-backend --region=us-central1 --format='value(serviceConfig.uri)')
        echo "Detected Backend URL: $$BACKEND_URL"

        sed -i "s|BACKEND_URL_PLACEHOLDER|$$BACKEND_URL|g" gcp-api-gateway.yaml
        
        cat gcp-api-gateway.yaml

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    args:
      - gcloud
      - api-gateway
      - api-configs
      - create
      - sw-config-${SHORT_SHA}
      - --api=sw-api
      - --openapi-spec=gcp-api-gateway.yaml
      - --backend-auth-service-account=587782644081-compute@developer.gserviceaccount.com
      - --project=${PROJECT_ID}

  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    args:
      - gcloud
      - api-gateway
      - gateways
      - update
      - sw-gateway
      - --api=sw-api
      - --api-config=sw-config-${SHORT_SHA}
      - --location=us-central1
      - --project=${PROJECT_ID}

options:
  logging: CLOUD_LOGGING_ONLY
